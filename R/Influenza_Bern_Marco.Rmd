---
title: "Influenza Bern"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Methoods

## Incidence and Reproduction number ( R effective)
* Incidence per 1'000 inhabitants
* Rolling average over 3 weeks

## Maps - Municipalities
* calculated only  for pandemic times:
  + 21.06.1918 - 20.09.1918
  + 27.09.1918 - 20.06.1919
  + 02.01.1920 - 18.06.1920
  + 23.12.1921 - 05.05.1922
  + 11.01.1924 - 30.05.1924
  + 12.12.1924 - 08.05.1925
* Incidence:
  + breaks: Jenks Natural Breaks - finds the "best" way to split up the ranges.
  + natural breaks minimizes the variation within each color, so the areas within each color are as close as possible in value to each other
  + quantile breaks do not work, because there are many zeros in the municipalities from 1920 onwards
* Hotspots:
  + local spatial statistic G
  + R package: spdep
  + returned is a Z-value
  + high positive values indicate the posibility of a local cluster of high values
  + low relative values a similar cluster of low values

## Co-factors for Pandemic 1918/1919

* sum of all cases per municipality for 1918 and 1919
* Incidence per 1'000 inhabitants
* Robust negative binomial regression to avoid over dispersion and to account for outliers.

<!-- * bivariate maps -->

<br />
<br />

The following co-factors were considered:

* Population density
* Altitude
* Precipitation (rain and snow from July 1918 through December 1919 ) -> However,altitude and precipitation are highly correlated. There is a significant interaction between altitude and precipitation. For that reason I would take only the altitude as co-factor for the total number of cases 1918/1919
* TB death
* Proportion of people working in agriculture and industry, I would take only one (same result only opposite)
* Proportion of  "Betriebe", "Anzahl Arbeiter in den Betriebe", "PS". 194 municipalities does not have any Betriebe
* Urbanity, only 3 cities -> not possible to use with this classification

<!-- For bivarite map clustering "quantile" clustering was used for population density, altitude, precipitation, tb death and proportion of people working in industry and agriculture. -->
<!-- Since  "Betriebe", "Anzahl Arbeiter in den Betriebe" and "PS" have a lot of zeros (no Beriebe) "quantile" clustering is not possible, therefor "jenks" was used. -->

# Canton Bern

```{r, echo=FALSE,message=FALSE, warning = FALSE,fig.height = 40,  fig.width = 80}
function_inc_all_plot()
# function_R_eff_all_plot()
```

# Regions of Bern

```{r echo=FALSE, out.width = '70%'}
knitr::include_graphics("../data/Map_Bern_Regions.png")
```

## Incidence
```{r, echo=FALSE,message=FALSE, warning = FALSE,fig.height = 120,  fig.width =  80}
function_R_inc_plot()
```

<!-- <!-- ## Reproductive Number --> -->

<!-- <!-- ```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 120,  fig.width = 80} --> -->
<!-- <!-- function_R_eff_plot() --> -->
<!-- <!-- ``` --> -->

# Municipality
## 1918 First wave

```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_hotspot_wave(pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
```

## 1918-1919 second wave

```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_hotspot_wave(pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
```

## 1920
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
function_hotspot_wave(pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

## 1922
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim9),  pandemic_end=as.Date(datlim10), Pandemic_Name="1922")
function_hotspot_wave(pandemic_start=as.Date(datlim9),  pandemic_end=as.Date(datlim10), Pandemic_Name="1922")
```

## 1924
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim11),  pandemic_end=as.Date(datlim12), Pandemic_Name="1924")
function_hotspot_wave(pandemic_start=as.Date(datlim11),  pandemic_end=as.Date(datlim12), Pandemic_Name="1924")
```

## End 1924 -1925
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start=as.Date(datlim13),  pandemic_end=as.Date(datlim14), Pandemic_Name="End 1924 - 1925")
function_hotspot_wave(pandemic_start=as.Date(datlim13),  pandemic_end=as.Date(datlim14), Pandemic_Name="End 1924 - 1925")
```

<!-- # Gif -->
<!-- ```{r echo=FALSE, out.width = '100%'} -->
<!-- knitr::include_graphics("../output/plot_animition.gif") -->
<!-- ``` -->

# Co-factors

## 1918 First Wave

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2))
```

## 1918/1919 second wave


```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6))
```

## 1920

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8))
```

## Population density

<!-- No evidence of a significant association between population density and incidence. However, trend that higher population density lead to higher incidence. -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_popdensity(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_popdensity(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_popdensity(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_popdensity(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_popdensity(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_popdensity(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_popdensity(Type="Maps") -->
<!-- ``` -->


## Altitude

<!-- There is a significant association between the altitude and the incidence. The higher the municipality, the lower the incidence. -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_altitude(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_altitude(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_altitude(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_altitude(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_altitude(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_altitude(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!--  function_altitude(Type="Maps") -->
<!-- ``` -->

<!-- ## Precipitation -->

<!-- There is a significant association between precipitation and the incidence. The more precipitation, the lower the incidence. -->
<!-- Altitude and precipitation show a significant interaction. I would not show precipitation for total cases per municipility. -->


<!-- <!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} --> -->
<!-- <!-- function_rain(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") --> -->
<!-- <!-- function_rain(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") --> -->
<!-- <!-- function_rain(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") --> -->
<!-- <!-- ``` --> -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_rain(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_rain(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_rain(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_rain(Type="Maps") -->
<!-- ``` -->

## Tuberculosis death

<!-- No evidence of a significant association. -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_tb(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_tb(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_tb(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_tb(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_tb(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_tb(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_tb(Type="Maps") -->
<!-- ``` -->

## People working in agriculture

<!-- First wave 1918: The higher the proportion of people working in agriculture, the lower the incidence (significant) -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: There is no evidence for a significant association between the proportion of people working in agriculture and incidence -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_lws(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_lws(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_lws(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_lws(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_lws(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_lws(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_lws(Type="Maps") -->
<!-- ``` -->

## People working in industry

<!-- First wave 1918: The higher the proportion of people working in industry, the higher the incidence (significant) -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: There is no evidence for a significant association between the proportion of people working in industry  and incidence -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_gew(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_gew(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_gew(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_gew(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_gew(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_gew(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_gew(Type="Maps") -->
<!-- ``` -->


## Industrial companies

<!-- First wave 1918: The higher the proportion of companies, the higher the incidence (significant) -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: There is no evidence for a significant association between proportion of companies and incidence. -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_betriebe(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_betriebe(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_betriebe(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->


```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_betriebe(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_betriebe(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_betriebe(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

<!-- <!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} --> -->
<!-- <!-- function_betriebe(Type="Maps") --> -->
<!-- <!-- ``` --> -->


## Total workers

<!-- First wave 1918: The higher the proportion of people working in industry, the higher the incidence (significant) -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: There is no evidence for a significant association between the proportion of people working in industry  and incidence -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_arbeiter(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_arbeiter(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_arbeiter(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_arbeiter(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_arbeiter(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_arbeiter(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

## PS

<!-- First wave 1918 and 1918/1919: There is no evidence for a significant association between PS and incidence, but positve trend. -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: The higher the PS in industry, the higher the incidence (significant) -->

<!-- <!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} --> -->
<!-- <!-- function_ps(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") --> -->
<!-- <!-- function_ps(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") --> -->
<!-- function_ps(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_ps(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_ps(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_ps(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_ps(Type="Maps") -->
<!-- ``` -->

## Number of stations

<!-- First wave 1918: Municipalities with at least on train station show siginificant higher incidence than municipalities without a train station -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Second wave 1918/1919 and 1920: There is no evidence for a significant association between train stations and incidence. -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_stations(Type="Regression",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave") -->
<!-- function_stations(Type="Regression",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave") -->
<!-- function_stations(Type="Regression",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920") -->
<!-- ``` -->

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_stations(Type="Figure",pandemic_start=as.Date(datlim1),  pandemic_end=as.Date(datlim2), Pandemic_Name="1918 first wave")
function_stations(Type="Figure",pandemic_start=as.Date(datlim3),  pandemic_end=as.Date(datlim6), Pandemic_Name="1918-1919 second wave")
function_stations(Type="Figure",pandemic_start=as.Date(datlim7),  pandemic_end=as.Date(datlim8), Pandemic_Name="1920")
```

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_ps(Type="Maps") -->
<!-- ``` -->
