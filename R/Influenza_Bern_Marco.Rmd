---
title: "Influenza Bern"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Methoods

## Incidence and Reproduction number ( R effective)
* Incidence per 1'000 inhabitants
* Rolling average over 3 weeks

## Maps - Municipalities
* calculated only  for pandemic times:
  + 28.06.1918 - 20.06.1919
  + 09.01.1920 - 18.06.1920
  + 06.01.1922 - 21.04.1922
  + 04.01.1924 - 06.06.1924
  + b1.11.1924 - 08.05.1925
* Incidence:
  + breaks: Jenks Natural Breaks - finds the "best" way to split up the ranges.
  + natural breaks minimizes the variation within each color, so the areas within each color are as close as possible in value to each other
  + quantile breaks do not work, because there are many zeros in the municipalities from 1920 onwards
* Hotspots:
  + local spatial statistic G
  + R package: spdep
  + returned is a Z-value
  + high positive values indicate the posibility of a local cluster of high values
  + low relative values a similar cluster of low values

## Co-factors for Pandemic 1918/1919

* sum of all cases per municipality
* Incidence per 1'000 inhabitants
* Negative binomial regression to avoid over dispersion
* bivariate maps
<\br>
<\br>
The following co-factors were considered:
<\br>
* Population Density
* Altitude
* Precipitation -> However,altitude and precipitation are highly correlated. There is a significant interaction between altitude and precipitation. For that reason I would take only the altitude as co-factor for the total number of cases 1918/1919
* TB death
* Proportion of people working in agriculture and industry, I would take only one (same result only opposite)
* Proportion of  "Betriebe", "Anzahl Arbeiter in den Betriebe", "PS". 194 municipalities does not have any Betriebe


* Urbanity, only 3 cities -> not possible with this classification

# Canton Bern

```{r, echo=FALSE,message=FALSE, warning = FALSE,fig.height = 40,  fig.width = 80}
function_inc_all_plot()
# function_R_eff_all_plot()
```

# Regions of Bern

```{r echo=FALSE, out.width = '70%'}
knitr::include_graphics("../data/Map_Bern_Regions.png")
```

## Incidence
```{r, echo=FALSE,message=FALSE, warning = FALSE,fig.height = 120,  fig.width =  80}
function_R_inc_plot()
```

<!-- ## Reproductive Number -->

<!-- ```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 120,  fig.width = 80} -->
<!-- function_R_eff_plot() -->
<!-- ``` -->

# Municipality
## 1918 First wave

```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1918-06-28",  pandemic_end="1918-09-20", Pandemic_Name="1918 first wave")
function_hotspot_wave(pandemic_start="1918-06-28",  pandemic_end="1918-09-20", Pandemic_Name="1918 first wave")
```

## 1918-1919 second wave

```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1918-09-27",  pandemic_end="1919-06-20", Pandemic_Name="1918-1919 second wave")
function_hotspot_wave(pandemic_start="1918-09-27",  pandemic_end="1919-06-20", Pandemic_Name="1918-1919 second wave")
```

## 1920
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1920-01-09",  pandemic_end="1920-06-18", Pandemic_Name="1920")
function_hotspot_wave(pandemic_start="1920-01-09",  pandemic_end="1920-06-18", Pandemic_Name="1920")
```

## 1922
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1922-01-06",  pandemic_end="1922-04-21", Pandemic_Name="1922")
function_hotspot_wave(pandemic_start="1922-01-06",  pandemic_end="1922-04-21", Pandemic_Name="1922")
```

## 1924
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1924-01-04",  pandemic_end="1924-06-06", Pandemic_Name="1924")
function_hotspot_wave(pandemic_start="1924-01-04",  pandemic_end="1924-06-06", Pandemic_Name="1924")
```

## End 1924 -1925
```{r, echo=FALSE,message=FALSE,warning = FALSE,fig.height = 30,  fig.width = 30}
function_plot_maps(pandemic_start="1924-11-21",  pandemic_end="1925-05-08", Pandemic_Name="End 1924 - 1925")
function_hotspot_wave(pandemic_start="1924-11-21",  pandemic_end="1925-05-08", Pandemic_Name="End 1924 - 1925")
```

<!-- # Gif -->
<!-- ```{r echo=FALSE, out.width = '100%'} -->
<!-- knitr::include_graphics("../output/plot_animition.gif") -->
<!-- ``` -->

## Co-factors

### Population density

Municipality with a higher population density have a significant higher incidence.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_popdensity(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_popdensity(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_popdensity(Type="Maps")
```


### Altitude

There is a significant correlation between the altitude and the incidence. The higher the municipality, the lower the incidence.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_altitude(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_altitude(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_altitude(Type="Maps")
```

### Precipitation

There is a significant correlation between Precipitation and the incidence. The more precipitation, the lower the incidence.
Altitude and precipitation show a significant interaction. I would not show precipitation for total cases per municipility. 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_rain(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_rain(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_rain(Type="Maps")
```

### Tuberculosis death

No evidence of a significant association, but trend that high TB deaths lead to lower incidence.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_tb(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_tb(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_tb(Type="Maps")
```

### people working in agriculture

There is no evidence for a significant association between the proportion of people working in agriculture and incidence. 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_lws(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_lws(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_lws(Type="Maps")
```

### people working in industry

There is no evidence for a significant association between the proportion of people working in agriculture and incidence. 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_gew(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_gew(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_gew(Type="Maps")
```


### Industrial companies

There is no evidence for a significant association between the numbers of industrual companies per 1'000 inhabitants and incidence.
However 194 municipality does not have any industrial companies. Grouping the "companies" in two (or more groups (e.g. none, same, a lot)) give the same result.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_betriebe(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_betriebe(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_betriebe(Type="Maps")
```


### Total workers

There is no evidence for a significant association between the numbers of workers per 1'000 inhabitants and incidence.
However 194 municipality does not have any industrial companies. Grouping the "total workers" in two (or more groups (e.g. none, same, a lot)) give the same result. 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_arbeiter(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_arbeiter(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_arbeiter(Type="Maps")
```

### PS

There is no evidence for a significant association between PS per 1'000 inhabitants and incidence.
However 194 municipality does not have any industrial companies. Grouping the "PS" in two (or more groups (e.g. none, same, a lot)) give the same result. 


```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_ps(Type="Regression")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_ps(Type="Figure")
```

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_ps(Type="Maps")
```
 